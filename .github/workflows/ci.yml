name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Debug Tokens
      shell: bash
      run: |
        echo "ðŸ” Checking tokens for @acsbe package access..."
        echo ""
        
        # Check ACSBE_TOKEN (preferred for @acsbe packages)
        if [ -n "${{ secrets.ACSBE_TOKEN }}" ]; then
          echo "âœ… ACSBE_TOKEN is set (preferred for @acsbe packages)"
          ACSBE_TOKEN_VALUE="${{ secrets.ACSBE_TOKEN }}"
          echo "ACSBE_TOKEN length: ${#ACSBE_TOKEN_VALUE}"
          echo "ACSBE_TOKEN first 4 chars: $(echo "$ACSBE_TOKEN_VALUE" | cut -c1-4)..."
        else
          echo "âš ï¸  ACSBE_TOKEN is not set"
          echo "   â†’ Create a PAT with 'read:packages' permission for @acsbe org"
          echo "   â†’ Add it as 'ACSBE_TOKEN' secret in repository settings"
        fi
        echo ""
        
        # Check GH_TOKEN
        GH_TOKEN_VALUE="${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}"
        if [ -n "${{ secrets.GH_TOKEN }}" ]; then
          echo "âœ… GH_TOKEN is set (custom token)"
        elif [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
          echo "âš ï¸  GH_TOKEN not set, using GITHUB_TOKEN (may not work for @acsbe packages)"
        else
          echo "âŒ No tokens available!"
        fi
        
        if [ -n "$GH_TOKEN_VALUE" ]; then
          echo "GH_TOKEN length: ${#GH_TOKEN_VALUE}"
          echo "GH_TOKEN first 4 chars: $(echo "$GH_TOKEN_VALUE" | cut -c1-4)..."
        fi
        echo ""
        echo "ðŸ“ Token priority for @acsbe packages:"
        echo "   1. ACSBE_TOKEN (if set) - Best for @acsbe org packages"
        echo "   2. GH_TOKEN (if set) - May not have @acsbe access"
        echo "   3. GITHUB_TOKEN (fallback) - Usually doesn't work for private org packages"
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
        ACSBE_TOKEN: ${{ secrets.ACSBE_TOKEN }}
    
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Setting up npm registry for @acsbe packages..."
        
        # Check if .npmrc exists and extract token from it
        NPMRC_TOKEN=""
        if [ -f ".npmrc" ]; then
          echo "ðŸ“„ Found existing .npmrc file"
          # Extract token using sed (more portable than grep -oP)
          NPMRC_TOKEN=$(grep '//npm.pkg.github.com/:_authToken=' .npmrc | sed 's/.*_authToken=//' | tr -d '\n' || echo "")
          if [ -n "$NPMRC_TOKEN" ]; then
            echo "âœ… Found token in .npmrc file"
            echo "âš ï¸  SECURITY WARNING: Token found in committed .npmrc file"
            echo "   Consider using GitHub Secrets instead for better security"
            echo "   Token length: ${#NPMRC_TOKEN}"
          else
            echo "â„¹ï¸  .npmrc exists but no token found"
          fi
        fi
        
        # Create/update .npmrc with registry
        echo '@acsbe:registry=https://npm.pkg.github.com' > .npmrc
        
        # Determine which token to use (priority: .npmrc > ACSBE_TOKEN > GH_TOKEN > GITHUB_TOKEN)
        if [ -n "$NPMRC_TOKEN" ]; then
          echo "âœ… Using token from .npmrc file"
          echo '//npm.pkg.github.com/:_authToken='$NPMRC_TOKEN >> .npmrc
        elif [ -n "${{ secrets.ACSBE_TOKEN }}" ]; then
          echo "âœ… Using ACSBE_TOKEN secret for @acsbe packages"
          echo '//npm.pkg.github.com/:_authToken='${{ secrets.ACSBE_TOKEN }} >> .npmrc
        elif [ -n "${{ secrets.GH_TOKEN }}" ]; then
          echo "âš ï¸  Using GH_TOKEN secret (may not have access to @acsbe packages)"
          echo '//npm.pkg.github.com/:_authToken='${{ secrets.GH_TOKEN }} >> .npmrc
        else
          echo "âš ï¸  Using GITHUB_TOKEN (may not have access to @acsbe packages)"
          echo '//npm.pkg.github.com/:_authToken='${{ secrets.GITHUB_TOKEN }} >> .npmrc
        fi
        
        echo ""
        echo "ðŸ“‹ .npmrc contents (token masked):"
        cat .npmrc | sed 's/_authToken=.*/_authToken=***MASKED***/'
        
        echo ""
        echo "ðŸ“¦ Installing dependencies..."
        npm ci
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
        ACSBE_TOKEN: ${{ secrets.ACSBE_TOKEN }}
    
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium
    
    - name: Build application
      run: npm run build
    
    - name: Run Playwright tests
      working-directory: test-suite
      run: npx playwright test --project=chromium
      env:
        CI: true
        ACCESSFLOW_API_KEY: ${{ secrets.ACCESSFLOW_API_KEY }}
    
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.node-version }}
        path: test-suite/playwright-report/
        retention-days: 7

