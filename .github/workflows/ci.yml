name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Debug Tokens
      shell: bash
      run: |
        echo "ðŸ” Checking tokens for @acsbe package access..."
        echo ""
        
        # Check ACSBE_TOKEN (preferred for @acsbe packages)
        if [ -n "${{ secrets.ACSBE_TOKEN }}" ]; then
          echo "âœ… ACSBE_TOKEN is set (preferred for @acsbe packages)"
          ACSBE_TOKEN_VALUE="${{ secrets.ACSBE_TOKEN }}"
          echo "ACSBE_TOKEN length: ${#ACSBE_TOKEN_VALUE}"
          echo "ACSBE_TOKEN first 4 chars: $(echo "$ACSBE_TOKEN_VALUE" | cut -c1-4)..."
        else
          echo "âš ï¸  ACSBE_TOKEN is not set"
          echo "   â†’ Create a PAT with 'read:packages' permission for @acsbe org"
          echo "   â†’ Add it as 'ACSBE_TOKEN' secret in repository settings"
        fi
        echo ""
        
        # Check GH_TOKEN
        GH_TOKEN_VALUE="${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}"
        if [ -n "${{ secrets.GH_TOKEN }}" ]; then
          echo "âœ… GH_TOKEN is set (custom token)"
        elif [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
          echo "âš ï¸  GH_TOKEN not set, using GITHUB_TOKEN (may not work for @acsbe packages)"
        else
          echo "âŒ No tokens available!"
        fi
        
        if [ -n "$GH_TOKEN_VALUE" ]; then
          echo "GH_TOKEN length: ${#GH_TOKEN_VALUE}"
          echo "GH_TOKEN first 4 chars: $(echo "$GH_TOKEN_VALUE" | cut -c1-4)..."
        fi
        echo ""
        echo "ðŸ“ Token priority for @acsbe packages:"
        echo "   1. ACSBE_TOKEN (if set) - Best for @acsbe org packages"
        echo "   2. GH_TOKEN (if set) - May not have @acsbe access"
        echo "   3. GITHUB_TOKEN (fallback) - Usually doesn't work for private org packages"
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
        ACSBE_TOKEN: ${{ secrets.ACSBE_TOKEN }}
    
    - name: Install local @acsbe/accessflow-sdk tarball
      run: |
        echo "ðŸ“¦ Checking for local @acsbe/accessflow-sdk tarball..."
        if [ -f "acsbe-accessflow-sdk-1.0.0.tgz" ]; then
          echo "âœ… Found acsbe-accessflow-sdk-1.0.0.tgz"
          echo "ðŸ“Š File size: $(ls -lh acsbe-accessflow-sdk-1.0.0.tgz | awk '{print $5}')"
          echo "ðŸ“¦ Installing local tarball package..."
          npm install ./acsbe-accessflow-sdk-1.0.0.tgz --save-dev
          echo "âœ… Local tarball installed successfully"
        else
          echo "âš ï¸  acsbe-accessflow-sdk-1.0.0.tgz not found - will try to install from registry"
        fi
    
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Setting up npm registry for @acsbe packages..."
        
        # Priority 1: Check if .npmrc exists and has token - use it directly
        if [ -f ".npmrc" ]; then
          echo "ðŸ“„ Found existing .npmrc file"
          
          # Check if it has @acsbe registry configured
          if grep -q "@acsbe:registry" .npmrc; then
            echo "âœ… @acsbe registry already configured in .npmrc"
          else
            echo "â„¹ï¸  Adding @acsbe registry to .npmrc"
            echo '@acsbe:registry=https://npm.pkg.github.com' >> .npmrc
          fi
          
          # Check if token exists
          if grep -q "//npm.pkg.github.com/:_authToken=" .npmrc; then
            echo "âœ… Token found in .npmrc file - using it directly"
            echo "âš ï¸  SECURITY WARNING: Token found in committed .npmrc file"
            echo "   Consider using GitHub Secrets instead for better security"
            
            # Extract token for verification
            NPMRC_TOKEN=$(grep '//npm.pkg.github.com/:_authToken=' .npmrc | sed 's/.*_authToken=//' | tr -d '\n' || echo "")
            if [ -n "$NPMRC_TOKEN" ]; then
              echo "   Token length: ${#NPMRC_TOKEN}"
            fi
            
            echo ""
            echo "ðŸ“‹ Using existing .npmrc (token masked):"
            cat .npmrc | sed 's/_authToken=.*/_authToken=***MASKED***/'
            echo ""
            echo "ðŸ“¦ Installing remaining dependencies with .npmrc token..."
            npm ci
            exit 0
          else
            echo "âš ï¸  .npmrc exists but no token found - will use secrets"
          fi
        else
          echo "â„¹ï¸  .npmrc file not found - will create one with token from secrets"
        fi
        
        # Priority 2: Use secrets if .npmrc doesn't have token
        echo ""
        echo "ðŸ”‘ Setting up .npmrc with token from secrets..."
        
        # Create/update .npmrc with registry
        if [ ! -f ".npmrc" ] || ! grep -q "@acsbe:registry" .npmrc; then
          echo '@acsbe:registry=https://npm.pkg.github.com' > .npmrc
        fi
        
        # Determine which token to use (priority: ACSBE_TOKEN > GH_TOKEN > GITHUB_TOKEN)
        if [ -n "${{ secrets.ACSBE_TOKEN }}" ]; then
          echo "âœ… Using ACSBE_TOKEN secret for @acsbe packages"
          echo '//npm.pkg.github.com/:_authToken='${{ secrets.ACSBE_TOKEN }} >> .npmrc
        elif [ -n "${{ secrets.GH_TOKEN }}" ]; then
          echo "âš ï¸  Using GH_TOKEN secret (may not have access to @acsbe packages)"
          echo '//npm.pkg.github.com/:_authToken='${{ secrets.GH_TOKEN }} >> .npmrc
        else
          echo "âš ï¸  Using GITHUB_TOKEN (may not have access to @acsbe packages)"
          echo '//npm.pkg.github.com/:_authToken='${{ secrets.GITHUB_TOKEN }} >> .npmrc
        fi
        
        echo ""
        echo "ðŸ“‹ .npmrc contents (token masked):"
        cat .npmrc | sed 's/_authToken=.*/_authToken=***MASKED***/'
        
        echo ""
        echo "ðŸ“¦ Installing remaining dependencies..."
        npm ci
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
        ACSBE_TOKEN: ${{ secrets.ACSBE_TOKEN }}
    
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium
    
    - name: Build application
      run: npm run build
    
    - name: Run Playwright tests
      working-directory: test-suite
      run: npx playwright test --project=chromium
      env:
        CI: true
        ACCESSFLOW_API_KEY: ${{ secrets.ACCESSFLOW_API_KEY }}
    
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.node-version }}
        path: test-suite/playwright-report/
        retention-days: 7

